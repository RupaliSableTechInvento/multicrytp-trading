{"version":3,"sources":["../../src/controller/messagesController.js"],"names":["path","require","bodyParser","users","keys","module","exports","app","io","use","json","urlencoded","extended","email","global","arrImgURL","friends","pending","all_friends","curentUserEmail","friendsData","sockets","on","socket","console","log","id","token","decoded","verify","App_key","isEmailFound","find","item","push","socketId","forEach","findOneAndUpdate","$set","isActive","_id","err","doc","res","tempImgURL","list","slice","length","i","status","senderEmail","to","emit","senderEmailList","map","aField","$in","imgURL","lean","exec","frndReqAccepted","name","first_name","frndDetails","To","user","reqFrom","senderFirstName","friendReq","ReqList","msgObj","sender","senderName","data","dataObj","date","Date","isRead","last_name","create","message","index","reciever","msg","post","req","setHeader","friend","models","body","my_handle","friend_handle","send","update","handle","$push","upsert","confirm"],"mappings":"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","file":"messagesController.js","sourcesContent":["import usersModel from '../models/usersModel'\r\nimport messagesModel from '../models/messagesModel'\r\nimport jwt from 'jsonwebtoken';\r\nimport env from \"../env\";\r\n\r\nimport { globalAgent } from 'http';\r\nvar path = require('path');\r\nvar bodyParser = require('body-parser');\r\nvar users = [];\r\nvar keys = {};\r\n\r\n\r\nmodule.exports = function(app, io) {\r\n  var app = app;\r\n  var io = io;\r\n  app.use(bodyParser.json());\r\n  app.use(bodyParser.urlencoded({\r\n    extended: true\r\n  }));\r\n\r\n  var email = global.email || null;\r\n  var arrImgURL = [];\r\n  var friends = [];\r\n  var pending = [];\r\n  var all_friends = [];\r\n  var curentUserEmail = '';\r\n  var friendsData = {};\r\n  io.sockets.on('connection', function(socket) {\r\n    console.log(\"On Connection =>\", socket.id);\r\n\r\n\r\n    socket.on('getActiveList', function(token) {\r\n      console.log(\"getActiveList=>>\", token);\r\n      var decoded = jwt.verify(token, env.App_key);\r\n      curentUserEmail = decoded.email;\r\n      const isEmailFound = users.find(item => item && item.email && item.email == curentUserEmail);\r\n      //console.log(\"isEmailFound in users\", users, isEmailFound);\r\n      if (!isEmailFound) {\r\n        users.push({\r\n            email: curentUserEmail,\r\n            socketId: socket.id\r\n          })\r\n          // console.log(\"Email Not present=>\", users, curentUserEmail);\r\n      } else {\r\n\r\n        users.forEach(item => {\r\n          if (item.email == curentUserEmail) {\r\n            item.email = curentUserEmail;\r\n            item.socketId = socket.id;\r\n\r\n          }\r\n\r\n\r\n        })\r\n\r\n      }\r\n\r\n\r\n      if (curentUserEmail) {\r\n        usersModel.findOneAndUpdate({ \"email\": curentUserEmail }, { $set: { isActive: \"active\" } }, { friends: 1, _id: 0 }, function(err, doc) {\r\n          if (err) {\r\n            console.log(\"error in io connection.=>\", err);\r\n            res.json(err);\r\n\r\n          } else {\r\n\r\n            pending = [];\r\n            var tempImgURL = '';\r\n            all_friends = [];\r\n            if (doc) {\r\n              var list = doc.friends.slice();\r\n              friends = [];\r\n              arrImgURL = [];\r\n              if (list.length > 0) {\r\n                console.log(\"List is not empty\");\r\n                for (var i in list) {\r\n                  if (list[i].status == \"Friend\" || list[i].status == \"Blocked\") {\r\n                    friends.push(list[i]);\r\n                    users.forEach(item => {\r\n                      if (item.email && list[i].senderEmail == item.email) {\r\n                        io.to(item.socketId).emit('friend_Ol', curentUserEmail);\r\n                        io.emit('friend_all', curentUserEmail);\r\n                      }\r\n                    })\r\n\r\n                  } else if (list[i].status == \"Pending\") {\r\n                    pending.push(list[i]);\r\n                  } else {\r\n                    continue;\r\n                  }\r\n                }\r\n\r\n\r\n                var senderEmailList = friends.map(function(aField) {\r\n                  return aField.senderEmail;\r\n                })\r\n                usersModel.find({ \"email\": { $in: senderEmailList } }, { imgURL: 1, email: 1, _id: 0 }).lean().exec(function(err, imgURL) {\r\n                  if (err) {\r\n\r\n                  } else {\r\n                    // console.log(\"friends ==>\", curentUserEmail, friends);\r\n                    friendsData = {\r\n                      friends: friends,\r\n                      arrImgURL: imgURL\r\n                    }\r\n\r\n                    io.to(socket.id).emit('friend_list', friendsData);\r\n                    io.to(socket.id).emit('pending_list', pending);\r\n                  }\r\n\r\n                });\r\n\r\n              }\r\n            }\r\n            // console.log(\"friendData=>\", friendsData);\r\n            //  io.emit('users', users);\r\n          }\r\n        });\r\n\r\n\r\n\r\n\r\n      }\r\n\r\n\r\n    })\r\n\r\n    socket.on('frndReqAccepted', function(frndReqAccepted) {\r\n      console.log(\"frndReqAccepted==>in soket on\", frndReqAccepted);\r\n      var decoded = jwt.verify(frndReqAccepted.token, env.App_key);\r\n      var email = decoded.email;\r\n      var name = decoded.first_name;\r\n      var imgURL = '';\r\n      var frndDetails = [];\r\n\r\n      console.log(\"frndDetails\", frndDetails);\r\n\r\n\r\n      users.forEach(item => {\r\n        if (item.email && frndReqAccepted.To == item.email) {\r\n          usersModel.find({ email: email }, { imgURL: 1, _id: 0 }, function(err, user) {\r\n            if (err) {\r\n              res.json(err);\r\n            } else {\r\n\r\n              imgURL = user[0].imgURL;\r\n              var reqFrom = {\r\n                senderEmail: email,\r\n                senderFirstName: name,\r\n                imgURL: imgURL,\r\n              }\r\n              frndDetails.push(reqFrom);\r\n              io.to(item.socketId).emit('reqAcceptedByFrnd', frndDetails);\r\n\r\n            }\r\n\r\n\r\n          });\r\n        }\r\n      })\r\n\r\n\r\n    })\r\n    socket.on('friendReq', function(friendReq) {\r\n      console.log(\"friendReq==>in soket on\", friendReq);\r\n      var decoded = jwt.verify(friendReq.token, env.App_key);\r\n      var email = decoded.email;\r\n      var name = decoded.first_name;\r\n      var ReqList = [];\r\n      var reqFrom = {\r\n        senderEmail: email,\r\n        senderFirstName: name,\r\n      }\r\n      ReqList.push(reqFrom);\r\n      console.log(\"ReqList\", ReqList);\r\n\r\n\r\n      users.forEach(item => {\r\n        if (item.email && friendReq.To == item.email) {\r\n          io.to(item.socketId).emit('friendReqRecieve', ReqList);\r\n        }\r\n      })\r\n\r\n\r\n    })\r\n    socket.on('private_message', function(msgObj) {\r\n      var decoded = jwt.verify(msgObj.token, env.App_key);\r\n      var sender = decoded.email;\r\n      var senderName = '';\r\n      var data = msgObj.dataObj;\r\n      data.sender = sender;\r\n      data.date = new Date();\r\n      data.isRead = false;\r\n\r\n      usersModel.find({ email: sender }, { last_name: 1, first_name: 1, _id: 0 }, function(err, user) {\r\n        if (err) {\r\n          res.json(err);\r\n        } else {\r\n          senderName = user[0].first_name + \" \" + user[0].last_name;\r\n          console.log(\"Sender Name=>\", senderName);\r\n          data.senderName = senderName;\r\n\r\n          messagesModel.create(data, function(err, message) {\r\n            if (err) { console.log(\"Error in add message\", err) } else {\r\n              users.forEach((item, index) => {\r\n                if (item && item.email == data.reciever) {\r\n                  console.log(\"Reciever found=>> \", item.email, data.reciever);\r\n                  io.to(item.socketId).emit('Notification_for_msg', message);\r\n                }\r\n              })\r\n\r\n            }\r\n          })\r\n\r\n        }\r\n\r\n\r\n      });\r\n\r\n\r\n    });\r\n\r\n    keys[socket.id] = email;\r\n\r\n    socket.on('group message', function(msg) {\r\n      // //console.log(msg);\r\n      io.emit('group', msg);\r\n    });\r\n\r\n    socket.on('disconnect', function() {\r\n      console.log(\"disconned call\", socket.id);\r\n\r\n      usersModel.findOneAndUpdate({ \"email\": curentUserEmail }, { $set: { isActive: \"inactive\" } },\r\n        function(err, doc) {\r\n          if (err) {\r\n            // res.json(err);\r\n          } else {\r\n            //console.log(\"logout=>\", doc)\r\n          }\r\n        });\r\n\r\n\r\n      delete socket.id;\r\n\r\n    });\r\n    // socket.on('reconnect', function() {\r\n    //   console.log(\"soket reconnceting..\");\r\n    // })\r\n  });\r\n\r\n\r\n\r\n\r\n\r\n  app.post('/friend_request', function(req, res) {\r\n    res.setHeader('Access-Control-Allow-Origin', '*');\r\n    res.setHeader(\"Access-Control-Allow-Method\", \"'GET, POST, OPTIONS, PUT, PATCH, DELETE'\");\r\n    friend = true;\r\n    models.user.find({ \"handle\": req.body.my_handle, \"friends.name\": req.body.friend_handle }, function(err, doc) {\r\n      if (err) { res.json(err); } else if (doc.length != 0) {\r\n\r\n        res.send(\"Friend request already sent \");\r\n      } else {\r\n\r\n        models.user.update({\r\n          handle: req.body.my_handle\r\n        }, {\r\n          $push: {\r\n            friends: {\r\n              name: req.body.friend_handle,\r\n              status: \"Pending\"\r\n            }\r\n          }\r\n        }, {\r\n          upsert: true\r\n        }, function(err, doc) {\r\n          if (err) { res.json(err); }\r\n          //            else{\r\n          //                //console.log(doc);\r\n          //            }\r\n        });\r\n        io.to(users[req.body.friend_handle]).emit('message', req.body);\r\n      }\r\n    });\r\n  });\r\n\r\n  app.post('/friend_request/confirmed', function(req, res) {\r\n    //console.log(\"friend request confirmed : \" + req.body);\r\n    if (req.body.confirm == \"Yes\") {\r\n      models.user.find({\r\n        \"handle\": req.body.friend_handle,\r\n        \"friends.name\": req.body.my_handle\r\n      }, function(err, doc) {\r\n        if (err) {\r\n          res.json(err);\r\n        } else if (doc.length != 0) {\r\n          //console.log(\"Friend request confirmed : \" + doc.length);\r\n          //console.log(\"Friend request confirmed : friend request already sent \" + doc);\r\n          res.send(\"Friend request already accepted\");\r\n        } else {\r\n          models.user.update({\r\n            \"handle\": req.body.my_handle,\r\n            \"friends.name\": req.body.friend_handle\r\n          }, {\r\n            '$set': {\r\n              \"friends.$.status\": \"Friend\"\r\n            }\r\n          }, function(err, doc) {\r\n            if (err) { res.json(err); } else {\r\n\r\n              //console.log(\"friend request confirmed : Inside yes confirmed\");\r\n              io.to(users[req.body.friend_handle]).emit('friend', req.body.my_handle);\r\n              io.to(users[req.body.my_handle]).emit('friend', req.body.friend_handle);\r\n            }\r\n          });\r\n          models.user.update({\r\n            handle: req.body.friend_handle\r\n          }, {\r\n            $push: {\r\n              friends: {\r\n                name: req.body.my_handle,\r\n                status: \"Friend\"\r\n              }\r\n            }\r\n          }, { upsert: true }, function(err, doc) {\r\n            if (err) { res.json(err); }\r\n            //            else{\r\n            //                //console.log(doc);\r\n            //            }\r\n          });\r\n        }\r\n      });\r\n    } else {\r\n\r\n\r\n      models.user.update({\r\n        \"handle\": req.body.my_handle\r\n      }, {\r\n        '$pull': {\r\n          'friends': {\r\n            \"name\": req.body.friend_handle,\r\n          }\r\n        }\r\n      }, function(err, doc) {\r\n        if (err) { res.json(err); } else {\r\n          //console.log(\"No\");\r\n        }\r\n      });\r\n    }\r\n  });\r\n\r\n}"]}