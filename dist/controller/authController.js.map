{"version":3,"sources":["../../src/controller/authController.js"],"names":["encode","require","hashCode","authController","login","req","res","next","console","log","body","password","value","credential","findOne","email","err","user","json","d","Date","v","setMinutes","getMinutes","token1","sign","first_name","last_name","expiry","App_key","token","currentTime","token2","isActive","userActiveTime","findOneAndUpdate","$and","$set","data","isError","create","id","_id","getActiveUser","find","tokenModel","emailObj","length","index","push","$in","register","params","query","save","logout","decoded","verify","headers"],"mappings":"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","file":"authController.js","sourcesContent":["import usersModel from './../models/usersModel';\r\nimport tokenModel from './../models/tokenModel';\r\nimport jwt from 'jsonwebtoken';\r\nimport env from \"../env\";\r\nimport tradeModel from '../models/postatrade';\r\nvar encode = require('hashcode').hashCode;\r\nconst authController = {\r\n  login: (req, res, next) => {\r\n    console.log(\"login api=>\", req.body)\r\n    req.body.password = encode().value(req.body.password);\r\n    const credential = req.body;\r\n    usersModel.findOne({\r\n      email: credential.email,\r\n      password: credential.password\r\n    }, (err, user) => {\r\n      if (err) res.json(err);\r\n      if (user !== null) {\r\n        console.log(\"User=>\", user)\r\n        var d = new Date();\r\n        var v = new Date();\r\n        v.setMinutes(d.getMinutes() + 10);\r\n        const token1 = jwt.sign({\r\n          email: user.email,\r\n          first_name: user.first_name,\r\n          last_name: user.last_name,\r\n          expiry: v\r\n        }, env.App_key);\r\n        let token = new tokenModel();\r\n        console.log(user.email);\r\n        var currentTime = new Date();\r\n        var token2 = { 'token': token1, email: user.email, isActive: \"active\", expiry: v, userActiveTime: currentTime };\r\n        tokenModel.findOneAndUpdate({ $and: [{ email: user.email }, { isActive: \"active\" }] }, { $set: { isActive: \"inactive\" } }, (err, data) => {\r\n          if (err) return res.json({ isError: true, data: err });\r\n          else {\r\n            tokenModel.create(token2, function(err, token) {\r\n              if (err) return res.json(err);\r\n              res.json({ isError: false, data: token1, user: { first_name: user.first_name, last_name: user.last_name, id: user._id } });\r\n            })\r\n          }\r\n        })\r\n      } else {\r\n        res.json({ isError: true, data: \"email or password incorrect !\" })\r\n      }\r\n    });\r\n  },\r\n\r\n  getActiveUser: async(req, res, next) => {\r\n    await tokenModel.find({ isActive: \"active\" }, (err, tokenModel) => {\r\n      if (err) return res.json({ isError: true, tokenModel: err });\r\n      else {\r\n        var emailObj = [];\r\n        console.log(\"trade model result\", tokenModel.length);\r\n        for (let index = 0; index < tokenModel.length; index++) {\r\n          emailObj.push(tokenModel[index].email);\r\n        }\r\n        console.log(\"active user email \", emailObj);\r\n\r\n        usersModel.find({ 'email': { $in: emailObj } }, (err, user) => {\r\n          if (err) return res.json({ isError: true, user: err });\r\n          else {\r\n            return res.json({ isError: false, tokenModel: tokenModel, user: user });\r\n          }\r\n        });\r\n      }\r\n    })\r\n  },\r\n\r\n  register: (req, res, next) => {\r\n    console.log(\"req.body\", req.body, req.params, req.query)\r\n    if (req.body.password != \"\" && req.body.password.length > 6) {\r\n      req.body.password = encode().value(req.body.password);\r\n      let user = new usersModel(req.body);\r\n      user.save(req.body, function(err, user) {\r\n        if (err) return res.json(err);\r\n        res.json(user)\r\n      })\r\n    } else {\r\n      res.json(\"Please provide valid password\");\r\n    }\r\n  },\r\n  logout: (req, res, next) => {\r\n    var decoded = jwt.verify(req.headers['authorization'], env.App_key);\r\n    tokenModel.findOneAndUpdate({ $and: [{ 'email': decoded.email }, { 'isActive': 'active' }] }, { $set: { 'isActive': 'inactive' } }, (err, data) => {\r\n      if (err) {\r\n        res.json({ isError: true, data: err });\r\n      } else {\r\n        res.json({ isError: false, data: data });\r\n      }\r\n    })\r\n  },\r\n};\r\n\r\nexport default authController;"]}